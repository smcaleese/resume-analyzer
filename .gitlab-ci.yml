stages:
  - setup
  - build
  - test
  - deploy

image: beevelop/nodejs-python:latest

before_script:
  stage: setup
    - apt-get install git-core

build_project:
  stage: build
  script:
    - cd src/backend
    - python -V
    - pip install -r requirements.txt
    - uvicorn server:app &
    - ps aux | grep -i "[u]vicorn" | awk {'print $2'} | xargs kill -9

test:
  stage: test
  script:
    - cd src/backend
    - pip install -r requirements.txt
    - npm install -g newman
    - newman --version
    - uvicorn server:app &
    - sleep 20
    - ps aux
    - ps aux | grep -i "[u]vicorn" 
    - ps aux | grep -i "[u]vicorn" | awk {'print $2'}
    - newman run ../tests/postman/status.postman_collection.json
    - ps aux | grep -i "[u]vicorn" | awk {'print $2'} | xargs kill -9

heroku:
  stage: deploy
  only:
    - master
  script:
    - git remote add heroku https://heroku:$HEROKU_API_KEY@git.heroku.com/fourth-year-project-api.git
    - git push heroku `git subtree split --prefix src/backend master`:master --force
